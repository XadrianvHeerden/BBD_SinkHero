<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Multiplayer Game</title>
    <script src="/socket.io/socket.io.js"></script>
    <script>

        document.addEventListener("DOMContentLoaded", () => {
            const socket = io();

            const ball = {
                radius: 10,
                ax: 0,
                ay: 0,
                vx: 0,
                vy: 0,

                data: null,
            }

            const FRAME_RATE = 30;
            let previousTimeStamp = performance.now();

            function update(timeStamp) {
                if (!ball.data)
                    return;

                let canvas = document.getElementById("maze");
                let ctx = canvas.getContext("2d");

                ctx.clearRect(
                    ball.data.x - ball.radius - 1,
                    ball.data.y - ball.radius - 1,
                    (ball.radius + 1) * 2, (ball.radius + 1) * 2);

                const delta = (timeStamp - previousTimeStamp) / (1000.0 / FRAME_RATE);

                let acceleration = ball.acceleration.getCopy();
                acceleration.scale(MAX_ACCELARATION);

                ball.data.x += ball.vx * delta;
                ball.data.y += ball.vy * delta;

                ctx.beginPath();
                ctx.arc(ball.data.x, ball.data.y, ball.radius, 0, 2 * Math.PI);
                ctx.fillStyle = ball.data.colour;
                ctx.fill();

                socket.emit("playerPositionChanged", player.data);

                previousTimeStamp = timeStamp;
                requestAnimationFrame(update);
            }

            document.getElementById('joinButton').addEventListener('click', () => {
                const name = document.getElementById('nameInput').value;
                if (name) {
                    socket.emit('setName', { name: name });
                    document.getElementById('gameInfo').innerHTML = ``;
                }
            });

            document.getElementById('startButton').addEventListener('click', () => {
                socket.emit('startGame');
            });

            document.getElementById('submitPositionButton').addEventListener('click', () => {
                const position = document.getElementById('positionInput').value;
                const gameId = document.getElementById('gameInfo').getAttribute('data-game-id');
                const playerId = document.getElementById('gameInfo').getAttribute('data-player-id');
                if (position && gameId && playerId) {
                    socket.emit('endRound', {
                        gameId: parseInt(gameId),
                        playerId: parseInt(playerId),
                        positions: [ // This array should be provided with all player positions, adjust as needed
                            { playerId: parseInt(playerId), points: parseInt(position) }
                        ]
                    });
                }
            });

            socket.on('waiting', (data) => {
                document.getElementById('joinSection').style.display = 'none';
                document.getElementById('waitingMessage').style.display = '';
                document.getElementById('waitingMessage').innerText = `Waiting for more players... (${data.playersCount}/4)`;
                document.getElementById('startSection').style.display = data.playersCount >= 2 ? 'block' : 'none';
            });

            socket.on('gameStart', (data) => {
                console.log(`Game ${data.gameId} started. You are player ${data.playerId} (Name: ${data.name})`);
                document.getElementById('gameInfo').innerHTML = `
                    <h2>Game Started!</h2>
                    <p>Game ID: ${data.gameId}</p>
                    <p>You are Player ${data.playerId} (Name: ${data.name})</p>
                `;
                document.getElementById('gameInfo').setAttribute('data-game-id', data.gameId);
                document.getElementById('gameInfo').setAttribute('data-player-id', data.playerId);
                document.getElementById('joinSection').style.display = 'none';
                document.getElementById('startSection').style.display = 'none';
                document.getElementById('waitingMessage').style.display = 'none';
                document.getElementById('positionSection').style.display = 'block';
                
                document.getElementById('maze').style.display = 'block';

                ball.data = data;
                requestAnimationFrame(update);
            });

            socket.on('playerLeft', (data) => {
                console.log(`Player ${data.playerId} left the game`);
            });

            socket.on('gameEnded', (data) => {
                console.log(`Game ${data.gameId} ended due to insufficient players.`);
                document.getElementById('gameInfo').innerHTML = `
                    <h2>Game Ended</h2>
                    <p>Game ID: ${data.gameId} ended due to insufficient players.</p>
                `;
                document.getElementById('joinSection').style.display = 'block';
                document.getElementById('startSection').style.display = 'none';
                document.getElementById('positionSection').style.display = 'none';
            });

            socket.on('pointsUpdated', (data) => {
                console.log('Points updated', data);
                let pointsInfo = '';
                data.players.forEach(player => {
                    pointsInfo += `<p>Player ${player.playerId}: ${player.points} points</p>`;
                });
                document.getElementById('gameInfo').innerHTML += pointsInfo;
            });

            addEventListener("deviceorientation", (event) => {
                let x = event.alpha;
                let y = event.beta;
                let z = event.gamma;

                ball.vx = y ? y : 1;
                ball.vy = z ? z : 1;
            });        
        });

    </script>
</head>
<body>
    <canvas id="maze" style="display: none; border: 1px solid black" width="500" height="500"></canvas>

    <h1>Multiplayer Game</h1>
    <div id="joinSection">
        <input type="text" id="nameInput" placeholder="Enter your name">
        <button id="joinButton">Join Game</button>
    </div>
    <div id="waitingMessage"></div>
    <div id="startSection" style="display: none;">
        <button id="startButton">Start Game</button>
    </div>
    <div id="positionSection" style="display: none;">
        <input type="number" id="positionInput" placeholder="Enter your position (1-4)">
        <button id="submitPositionButton">Submit Position</button>
    </div>
    <div id="gameInfo"></div>
    <p>Open this page in multiple tabs to simulate multiple players connecting.</p>
</body>
</html>
